var __awaiter=(this&&this.__awaiter)||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};import{doc as docRef,getDoc}from"firebase/firestore";import{get,set,del,createStore}from"idb-keyval";const timeout=(ms)=>new Promise(resolve=>setTimeout(resolve,ms));function requestDoc(db,path,retryOptions){const retryDelay=(retryOptions===null||retryOptions===void 0?void 0:retryOptions.retryDelay)||0;const maxRetries=(retryOptions===null||retryOptions===void 0?void 0:retryOptions.maxRetries)||3;let retries=0;function request(){var _a;return __awaiter(this,void 0,void 0,function*(){try{return yield getDoc(docRef(db,path));}catch(err){if(retryOptions===null||retryOptions===void 0?void 0:retryOptions.enabled){if(retries<(maxRetries-1)){retries++;if(!(retryOptions===null||retryOptions===void 0?void 0:retryOptions.retryOnErrorCode)){yield timeout(retryDelay);return yield request();}else if((_a=retryOptions===null||retryOptions===void 0?void 0:retryOptions.retryOnErrorCode)===null||_a===void 0?void 0:_a.includes(err===null||err===void 0?void 0:err.code)){yield timeout(retryDelay);return yield request();}else{throw new Error("Firestore threw an error but its code was not in the list of error codes to retry on");}}}throw err;}});}return request();}function getDocWrapper(db,path,options){return new Promise((resolve,reject)=>__awaiter(this,void 0,void 0,function*(){const firestoreWrapperCache=createStore("firestoreWrapperCache","docs");yield get(path,firestoreWrapperCache).then((cacheEntry)=>__awaiter(this,void 0,void 0,function*(){var _a,_b,_c,_d,_e,_f,_g,_h,_j,_k;const persistentCacheTime=cacheEntry===null||cacheEntry===void 0?void 0:cacheEntry.persistentCacheTime;if(!((_a=options===null||options===void 0?void 0:options.cacheOptions)===null||_a===void 0?void 0:_a.enabled)){if((Date.now()-(cacheEntry===null||cacheEntry===void 0?void 0:cacheEntry.fetchedAt))<persistentCacheTime){resolve(cacheEntry===null||cacheEntry===void 0?void 0:cacheEntry.doc);}else{try{const doc=yield requestDoc(db,path,options===null||options===void 0?void 0:options.retryOptions);resolve(doc.data());}catch(err){reject(err);}}return;}if(!cacheEntry){yield requestDoc(db,path,options===null||options===void 0?void 0:options.retryOptions).then(doc=>{var _a,_b,_c,_d;const newDocEntry={fetchedAt:Date.now(),doc:doc.data()};if((_b=(_a=options===null||options===void 0?void 0:options.cacheOptions)===null||_a===void 0?void 0:_a.cacheTime)===null||_b===void 0?void 0:_b.locked){newDocEntry.persistentCacheTime=(_d=(_c=options===null||options===void 0?void 0:options.cacheOptions)===null||_c===void 0?void 0:_c.cacheTime)===null||_d===void 0?void 0:_d.time;}set(path,newDocEntry,firestoreWrapperCache);resolve(doc.data());}).catch(err=>{reject(err);});return;}if((_b=options===null||options===void 0?void 0:options.cacheOptions)===null||_b===void 0?void 0:_b.forceRefresh){yield del(path,firestoreWrapperCache).then(()=>__awaiter(this,void 0,void 0,function*(){yield requestDoc(db,path,options===null||options===void 0?void 0:options.retryOptions).then(newDoc=>{var _a,_b,_c,_d;const newDocEntry={fetchedAt:Date.now(),doc:newDoc.data()};if((_b=(_a=options===null||options===void 0?void 0:options.cacheOptions)===null||_a===void 0?void 0:_a.cacheTime)===null||_b===void 0?void 0:_b.locked){newDocEntry.persistentCacheTime=(_d=(_c=options===null||options===void 0?void 0:options.cacheOptions)===null||_c===void 0?void 0:_c.cacheTime)===null||_d===void 0?void 0:_d.time;}set(path,newDocEntry,firestoreWrapperCache);resolve(newDoc.data());});})).catch(err=>{reject(err);});return;}if(persistentCacheTime&&!((_d=(_c=options===null||options===void 0?void 0:options.cacheOptions)===null||_c===void 0?void 0:_c.cacheTime)===null||_d===void 0?void 0:_d.bypassLockedTime)){if((_f=(_e=options===null||options===void 0?void 0:options.cacheOptions)===null||_e===void 0?void 0:_e.cacheTime)===null||_f===void 0?void 0:_f.locked){if((Date.now()-(cacheEntry===null||cacheEntry===void 0?void 0:cacheEntry.fetchedAt))<((_h=(_g=options===null||options===void 0?void 0:options.cacheOptions)===null||_g===void 0?void 0:_g.cacheTime)===null||_h===void 0?void 0:_h.time)){resolve(cacheEntry===null||cacheEntry===void 0?void 0:cacheEntry.doc);return;}}else if((Date.now()-(cacheEntry===null||cacheEntry===void 0?void 0:cacheEntry.fetchedAt))<persistentCacheTime){resolve(cacheEntry===null||cacheEntry===void 0?void 0:cacheEntry.doc);return;}}else{if((Date.now()-(cacheEntry===null||cacheEntry===void 0?void 0:cacheEntry.fetchedAt))<((_k=(_j=options===null||options===void 0?void 0:options.cacheOptions)===null||_j===void 0?void 0:_j.cacheTime)===null||_k===void 0?void 0:_k.time)){resolve(cacheEntry===null||cacheEntry===void 0?void 0:cacheEntry.doc);return;}}yield del(path,firestoreWrapperCache).then(()=>__awaiter(this,void 0,void 0,function*(){yield requestDoc(db,path,options===null||options===void 0?void 0:options.retryOptions).then(newDoc=>{var _a,_b,_c,_d;const newDocEntry={fetchedAt:Date.now(),doc:newDoc.data()};if((_b=(_a=options===null||options===void 0?void 0:options.cacheOptions)===null||_a===void 0?void 0:_a.cacheTime)===null||_b===void 0?void 0:_b.locked){newDocEntry.persistentCacheTime=(_d=(_c=options===null||options===void 0?void 0:options.cacheOptions)===null||_c===void 0?void 0:_c.cacheTime)===null||_d===void 0?void 0:_d.time;}set(path,newDocEntry,firestoreWrapperCache);resolve(newDoc.data());});})).catch(err=>{reject(err);});})).catch(err=>{reject(err);});}));}export default getDocWrapper;